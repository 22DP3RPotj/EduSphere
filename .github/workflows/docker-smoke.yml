name: Docker Smoke

on:
  push:
    paths:
      - 'docker/**'
      - 'docker-compose.yml'
      - 'docker.env'
      - 'backend/**'
      - 'frontend/**'
      - 'pyproject.toml'
      - 'poetry.lock'
      - '.github/workflows/**'
  pull_request:
    paths:
      - 'docker/**'
      - 'docker-compose.yml'
      - 'docker.env'
      - 'backend/**'
      - 'frontend/**'
      - 'pyproject.toml'
      - 'poetry.lock'
      - '.github/workflows/**'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  docker-smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    env:
      SECRET_KEY: test_secret_key
      DEBUG: 'False'
      DB_NAME: test_db
      DB_USER: test_user
      DB_PASSWORD: test_pass
      DB_HOST: postgres
      DB_PORT: '5432'
      DATABASE_URL: postgresql://test_user:test_pass@postgres:5432/test_db
      REDIS_HOST: redis
      REDIS_PORT: '6379'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Show Docker versions
        run: |
          docker --version
          docker compose version

      - name: Build images
        run: docker compose build --pull

      - name: Start stack (wait for readiness)
        run: |
          set -euo pipefail
          docker compose up -d --wait --wait-timeout 120

      - name: Django basic checks (inside backend)
        run: |
          set -euo pipefail
          docker compose exec -T backend poetry run python manage.py check
          docker compose exec -T backend poetry run python manage.py migrate --noinput

      - name: HTTP smoke via nginx
        run: |
          set -euo pipefail

          root_code="$(curl -sS --retry 10 --retry-connrefused --retry-delay 2 -o /dev/null -w '%{http_code}' http://localhost/)"
          echo "GET / -> $root_code"
          if [ "$root_code" -ge 500 ] || [ "$root_code" = "000" ]; then
            echo "Unexpected root status: $root_code"
            docker compose logs --no-color --tail=300 nginx
            docker compose logs --no-color --tail=300 backend
            exit 1
          fi

          graphql_code="$(curl -s -o /dev/null -w '%{http_code}' http://localhost/graphql/ || true)"
          echo "GET /graphql/ -> ${graphql_code:-unknown}"
          if [ -n "$graphql_code" ] && [ "$graphql_code" != "000" ] && [ "$graphql_code" -ge 500 ]; then
            echo "Unexpected graphql status: $graphql_code"
            docker compose logs --no-color --tail=300 nginx
            docker compose logs --no-color --tail=300 backend
            exit 1
          fi

      - name: Show logs
        if: always()
        run: |
          docker compose ps
          docker compose logs --no-color --tail=200

      - name: Teardown
        if: always()
        run: docker compose down -v
